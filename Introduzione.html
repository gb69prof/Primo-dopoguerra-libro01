<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pagina libro — Approfondimenti a finestre</title>
  <style>
    :root{
      --paper:#fbf6ea;
      --ink:#1f1f1f;
      --muted:#6a6258;
      --line:#d7c9ad;
      --accent:#7a2e2e;
      --shadow: 0 18px 45px rgba(0,0,0,.12);
      --radius: 16px;
      --serif: ui-serif, "Iowan Old Style", "Palatino Linotype", Palatino, Georgia, serif;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(122,46,46,.08), transparent 60%),
        radial-gradient(1100px 650px at 90% 20%, rgba(70,90,120,.07), transparent 55%),
        #f1efe8;
      color:var(--ink);
      font-family:var(--sans);
      overflow-x:hidden;
    }

    .wrap{ max-width: 980px; margin: 28px auto; padding: 0 14px 34px; }

    .book{
      background: linear-gradient(180deg, rgba(255,255,255,.35), transparent 38%), var(--paper);
      border:1px solid rgba(140,120,90,.25);
      border-radius: 24px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      padding: 22px 26px 10px;
      border-bottom:1px solid rgba(140,120,90,.22);
      background:
        linear-gradient(90deg, rgba(122,46,46,.08), transparent 45%),
        linear-gradient(180deg, rgba(255,255,255,.35), transparent 60%);
    }

    .title{
      margin:0;
      font-family:var(--serif);
      font-weight: 700;
      letter-spacing: .2px;
      font-size: clamp(20px, 2.2vw, 30px);
    }

    .meta{ color:var(--muted); font-size: 13px; line-height: 1.35; max-width: 420px; }

    .page{
      position: relative;
      margin: 18px;
      padding: 22px 26px;
      background: rgba(255,255,255,.22);
      border:1px solid rgba(140,120,90,.22);
      border-radius: var(--radius);
    }

    .page:before{
      content:"";
      position:absolute;
      inset: 10px 12px;
      border: 1px dashed rgba(140,120,90,.25);
      border-radius: 14px;
      pointer-events:none;
    }

    .page p{
      font-family:var(--serif);
      font-size: 17px;
      line-height: 1.72;
      margin: 0 0 12px;
      text-align: justify;
      hyphens:auto;
    }

    .divider{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(140,120,90,.35), transparent);
      margin: 12px 0 14px;
    }

    /* Termini apri-finestra */
    .pop-ref{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 0 2px;
      border-bottom: 2px solid rgba(122,46,46,.25);
      cursor:pointer;
      text-decoration:none;
      color: inherit;
      border-radius: 6px;
      transition: background .15s ease, border-color .15s ease;
    }
    .pop-ref:hover{ background: rgba(122,46,46,.08); border-color: rgba(122,46,46,.42); }

    .badge{
      font-family:var(--sans);
      font-size: 11px;
      line-height: 1;
      padding: 3px 6px;
      border-radius: 999px;
      border: 1px solid rgba(122,46,46,.32);
      background: rgba(255,255,255,.55);
      color: var(--accent);
      transform: translateY(-1px);
      user-select:none;
    }

    /* =============================
       FINESTRE: draggable + resizable
       ============================= */
    .win{
      position: fixed;
      left: 60px;
      top: 120px;
      width: min(420px, calc(100vw - 40px));
      height: 260px;
      background: rgba(255,250,240,.98);
      border: 1px solid rgba(140,120,90,.35);
      border-radius: 16px;
      box-shadow: 0 18px 45px rgba(0,0,0,.18);
      overflow: hidden;
      z-index: 1000;
      backdrop-filter: blur(2px);
    }

    .win[data-min="true"]{ height: 46px !important; }

    .win-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px 8px 12px;
      background:
        linear-gradient(90deg, rgba(122,46,46,.10), transparent 55%),
        rgba(255,255,255,.42);
      border-bottom: 1px solid rgba(140,120,90,.25);
      cursor: grab;
      user-select:none;
      touch-action:none; /* IMPORTANT: permette drag su touch */
    }

    .win-header:active{ cursor: grabbing; }

    .win-title{
      font-family:var(--sans);
      font-size: 13px;
      letter-spacing:.3px;
      text-transform: uppercase;
      color: rgba(31,31,31,.88);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70%;
    }

    .win-actions{ display:flex; gap:6px; align-items:center; }

    .btn{
      appearance:none;
      border: 1px solid rgba(140,120,90,.35);
      background: rgba(255,255,255,.7);
      border-radius: 10px;
      padding: 6px 8px;
      font-family: var(--sans);
      font-size: 12px;
      color: rgba(31,31,31,.88);
      cursor:pointer;
    }

    .btn:hover{ background: rgba(255,255,255,.95); }

    .win-body{
      height: calc(100% - 46px);
      padding: 12px 14px 14px;
      overflow:auto;
      font-family: var(--serif);
      font-size: 14.8px;
      line-height: 1.55;
      color: rgba(31,31,31,.92);
    }

    /* Maniglia resize (touch-friendly) */
    .resize-handle{
      position:absolute;
      right: 8px;
      bottom: 8px;
      width: 18px;
      height: 18px;
      border-radius: 6px;
      background:
        linear-gradient(135deg, rgba(122,46,46,.10), rgba(122,46,46,.0)),
        rgba(140,120,90,.20);
      border: 1px solid rgba(140,120,90,.35);
      cursor: nwse-resize;
      touch-action:none;
    }

    .hint{
      padding: 0 26px 18px;
      color: var(--muted);
      font-size: 13px;
      border-top: 1px solid rgba(140,120,90,.18);
      background: rgba(255,255,255,.14);
    }

    /* Preferenze accessibilità: riduci motion */
    @media (prefers-reduced-motion: reduce){
      *{ scroll-behavior:auto !important; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="book">
      <div class="header">
        <h1 class="title">Il mondo dopo la Prima guerra mondiale</h1>
        <div class="meta">
          Esempio concreto con approfondimenti come <b>finestre mobili</b>: trascina, ridimensiona, minimizza, chiudi.
          <br/>Clicca i termini numerati nel testo.
        </div>
      </div>

      <main class="page" id="page">
        <div class="divider"></div>

        <p>
          La Prima guerra mondiale segnò una frattura profonda nella storia contemporanea. Non si trattò soltanto
          della fine di un conflitto armato, ma del crollo di un equilibrio politico, economico e sociale che aveva retto
          l’Europa e gran parte del mondo fino al 1914. Il dopoguerra si aprì come un tempo instabile, attraversato da crisi,
          speranze e paure, destinato a incidere in modo decisivo sulle vicende dei singoli Stati.
        </p>

        <p>
          La fine degli imperi centrali (impero tedesco e impero austro-ungarico) e il ridisegno dei confini non portarono
          a una pace duratura. Le nuove democrazie nate dopo il conflitto si rivelarono spesso fragili, incapaci di rispondere
          alle aspettative di popolazioni provate dalla guerra. In Russia, la
          <a class="pop-ref" href="#" data-pop="rivoluzione" title="Apri finestra approfondimento">
            rivoluzione bolscevica <span class="badge">2</span>
          </a>
          aveva aperto la strada a un esperimento politico radicale, fondato sulla dittatura del partito unico e sulla
          trasformazione forzata della società.
        </p>

        <p>
          Anche gli Stati Uniti, pur usciti rafforzati dalla guerra, scelsero inizialmente la via dell’
          <a class="pop-ref" href="#" data-pop="isolazionismo" title="Apri finestra approfondimento">
            isolazionismo <span class="badge">4</span>
          </a>
          , rinunciando a un ruolo diretto nella costruzione di un nuovo ordine internazionale.
        </p>

        <p>
          Gli squilibri accumulati esplosero con la
          <a class="pop-ref" href="#" data-pop="crisi1929" title="Apri finestra approfondimento">
            crisi del 1929 <span class="badge">3</span>
          </a>
          , che mostrò i limiti del capitalismo liberale.
        </p>

        <p>
          Negli Stati Uniti la risposta fu il
          <a class="pop-ref" href="#" data-pop="newdeal" title="Apri finestra approfondimento">
            New Deal <span class="badge">1</span>
          </a>
          , una politica di intervento statale nell’economia che segnò una svolta storica.
        </p>

        <div class="divider"></div>
        <p style="margin:0; color:var(--muted); font-family:var(--sans); font-size:13px;">
          Nota: questa demo è pensata per funzionare anche su iPad (touch drag + resize).
        </p>
      </main>

      <div class="hint">
        <b>Come usarle:</b> trascina la barra in alto; ridimensiona dalla maniglia in basso a destra; “–” minimizza; “×” chiude.
      </div>
    </div>
  </div>

  <!-- TEMPLATES (contenuti approfondimenti) -->
  <template id="tpl-newdeal">
    <div>
      <p>
        <b>New Deal</b>: programma di riforme economiche e sociali avviato negli Stati Uniti negli anni ’30 per rispondere
        alla crisi. Lo Stato interviene direttamente con lavori pubblici, sostegno all’occupazione, regole per finanza e banche,
        e misure di protezione sociale.
      </p>
      <p>
        È una svolta: non basta “lasciare fare” al mercato. Serve un timone pubblico, almeno nei momenti di tempesta.
      </p>
    </div>
  </template>

  <template id="tpl-crisi1929">
    <div>
      <p>
        <b>Crisi del 1929</b>: il crollo di Wall Street innesca una crisi globale. Fallimenti bancari, disoccupazione,
        crollo della domanda e instabilità politica.
      </p>
      <p>
        In molti paesi la crisi alimenta l’idea che “serva un uomo forte” e accelera le radicalizzazioni.
      </p>
    </div>
  </template>

  <template id="tpl-rivoluzione">
    <div>
      <p>
        <b>Rivoluzione bolscevica (1917)</b>: i bolscevichi guidati da Lenin prendono il potere in Russia.
        Nasce uno Stato a partito unico che mira a trasformare economia e società in modo forzato.
      </p>
      <p>
        In Europa la paura di un “contagio rivoluzionario” diventa un fattore politico enorme.
      </p>
    </div>
  </template>

  <template id="tpl-isolazionismo">
    <div>
      <p>
        <b>Isolazionismo USA</b>: dopo la guerra, gli Stati Uniti scelgono spesso di ridurre gli impegni stabili
        negli equilibri europei (meno alleanze, meno interventi).
      </p>
      <p>
        Effetto collaterale: l’Europa resta più esposta a crisi e tensioni senza un arbitro forte.
      </p>
    </div>
  </template>

  <script>
    (function(){
      const openers = Array.from(document.querySelectorAll('.pop-ref'));
      const activeWindows = new Map(); // key -> element
      let topZ = 1000;

      function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

      function bringToFront(win){
        topZ += 1;
        win.style.zIndex = String(topZ);
      }

      function createWindow(key){
        const id = 'tpl-' + key;
        const tpl = document.getElementById(id);
        if(!tpl){
          console.warn('Template non trovato:', id);
          return null;
        }

        const win = document.createElement('section');
        win.className = 'win';
        win.setAttribute('role', 'dialog');
        win.setAttribute('aria-label', 'Approfondimento ' + key);
        win.dataset.key = key;

        // posizione iniziale a cascata
        const offset = activeWindows.size * 22;
        win.style.left = (60 + offset) + 'px';
        win.style.top  = (120 + offset) + 'px';

        const header = document.createElement('div');
        header.className = 'win-header';

        const title = document.createElement('div');
        title.className = 'win-title';
        // titoli carini
        const titles = {
          newdeal: 'Approfondimento 1 — New Deal',
          crisi1929: 'Approfondimento 3 — Crisi del 1929',
          rivoluzione: 'Approfondimento 2 — Rivoluzione bolscevica',
          isolazionismo: 'Approfondimento 4 — Isolazionismo USA'
        };
        title.textContent = titles[key] || ('Approfondimento — ' + key);

        const actions = document.createElement('div');
        actions.className = 'win-actions';

        const btnMin = document.createElement('button');
        btnMin.className = 'btn';
        btnMin.type = 'button';
        btnMin.textContent = '–';
        btnMin.title = 'Minimizza';

        const btnClose = document.createElement('button');
        btnClose.className = 'btn';
        btnClose.type = 'button';
        btnClose.textContent = '×';
        btnClose.title = 'Chiudi';

        actions.appendChild(btnMin);
        actions.appendChild(btnClose);

        header.appendChild(title);
        header.appendChild(actions);

        const body = document.createElement('div');
        body.className = 'win-body';
        body.appendChild(tpl.content.cloneNode(true));

        const handle = document.createElement('div');
        handle.className = 'resize-handle';
        handle.title = 'Ridimensiona';

        win.appendChild(header);
        win.appendChild(body);
        win.appendChild(handle);

        // Eventi
        win.addEventListener('pointerdown', () => bringToFront(win));

        btnClose.addEventListener('click', (e) => {
          e.stopPropagation();
          activeWindows.delete(key);
          win.remove();
        });

        btnMin.addEventListener('click', (e) => {
          e.stopPropagation();
          const isMin = win.dataset.min === 'true';
          win.dataset.min = isMin ? 'false' : 'true';
        });

        makeDraggable(win, header);
        makeResizable(win, handle);

        document.body.appendChild(win);
        bringToFront(win);

        return win;
      }

      function makeDraggable(win, header){
        let startX=0, startY=0, startLeft=0, startTop=0;
        let dragging = false;

        header.addEventListener('pointerdown', (e) => {
          // evita drag se clicchi sui bottoni
          if(e.target.closest('button')) return;

          dragging = true;
          bringToFront(win);

          const r = win.getBoundingClientRect();
          startX = e.clientX;
          startY = e.clientY;
          startLeft = r.left;
          startTop  = r.top;

          header.setPointerCapture(e.pointerId);
        });

        header.addEventListener('pointermove', (e) => {
          if(!dragging) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;

          const newLeft = startLeft + dx;
          const newTop  = startTop  + dy;

          // clamp dentro viewport con un minimo di margine
          const vw = window.innerWidth;
          const vh = window.innerHeight;
          const r = win.getBoundingClientRect();
          const w = r.width;
          const h = r.height;

          win.style.left = clamp(newLeft, 10 - (w-60), vw - 60) + 'px';
          win.style.top  = clamp(newTop,  10, vh - 60) + 'px';
        });

        header.addEventListener('pointerup', (e) => {
          dragging = false;
          try{ header.releasePointerCapture(e.pointerId); }catch(_){ }
        });

        header.addEventListener('pointercancel', (e) => {
          dragging = false;
          try{ header.releasePointerCapture(e.pointerId); }catch(_){ }
        });
      }

      function makeResizable(win, handle){
        let startX=0, startY=0, startW=0, startH=0;
        let resizing = false;

        handle.addEventListener('pointerdown', (e) => {
          resizing = true;
          bringToFront(win);

          const r = win.getBoundingClientRect();
          startX = e.clientX;
          startY = e.clientY;
          startW = r.width;
          startH = r.height;

          handle.setPointerCapture(e.pointerId);
        });

        handle.addEventListener('pointermove', (e) => {
          if(!resizing) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;

          const minW = 260;
          const minH = 180;
          const maxW = Math.min(window.innerWidth - 20, 720);
          const maxH = Math.min(window.innerHeight - 20, 620);

          const newW = clamp(startW + dx, minW, maxW);
          const newH = clamp(startH + dy, minH, maxH);

          win.style.width = newW + 'px';
          if(win.dataset.min !== 'true') win.style.height = newH + 'px';
        });

        handle.addEventListener('pointerup', (e) => {
          resizing = false;
          try{ handle.releasePointerCapture(e.pointerId); }catch(_){ }
        });

        handle.addEventListener('pointercancel', (e) => {
          resizing = false;
          try{ handle.releasePointerCapture(e.pointerId); }catch(_){ }
        });
      }

      // Apri finestra al click sul termine
      openers.forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const key = a.getAttribute('data-pop');
          if(!key) return;

          // se già aperta, porta davanti
          if(activeWindows.has(key)){
            const win = activeWindows.get(key);
            if(win){ bringToFront(win); }
            return;
          }

          const win = createWindow(key);
          if(win) activeWindows.set(key, win);
        });
      });

      // scorciatoia: ESC chiude la finestra top
      document.addEventListener('keydown', (e) => {
        if(e.key !== 'Escape') return;
        // trova il win con z-index più alto
        const wins = Array.from(document.querySelectorAll('.win'));
        if(!wins.length) return;
        let top = wins[0];
        for(const w of wins){
          if(parseInt(w.style.zIndex||'0',10) > parseInt(top.style.zIndex||'0',10)) top = w;
        }
        const k = top.dataset.key;
        activeWindows.delete(k);
        top.remove();
      });

    })();
  </script>
</body>
</html>
